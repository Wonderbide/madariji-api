create table ai_flow_configuration (is_active boolean not null, priority integer, created_at timestamp(6) not null, updated_at timestamp(6), id uuid not null, created_by varchar(255), flow_type varchar(255) not null check (flow_type in ('WORD_ANALYSIS','PAGE_STRUCTURING')), model_id varchar(255) not null, provider varchar(255) not null check (provider in ('GOOGLE','OPENAI')), primary key (id));
create table book (last_successfully_processed_page_index integer, total_pages integer, total_word_count integer, vision_batch_size integer, uploaded_at timestamp(6) with time zone not null, id uuid not null, user_id uuid not null, published_date_text varchar(50), status varchar(50) not null check (status in ('PENDING','TEXT_EXTRACTION_IN_PROGRESS','PROCESSING','PROCESSING_GEMINI','COMPLETED','COMPLETED_WITH_ERRORS','PAUSED_ON_ERROR','OCR_COMPLETED','FAILED','AWAITING_ENRICHMENT','PROCESSING_OCR_RESULTS','ENRICHMENT_IN_PROGRESS','PARTIALLY_ENRICHED')), visibility_status varchar(50) not null check (visibility_status in ('PUBLIC','PRIVATE')), genre varchar(100), cover_image_path varchar(1024), final_content_path varchar(1024), local_pdf_path varchar(1024) not null, author_name varchar(255), description varchar(255), processing_details TEXT, title varchar(255) not null, vision_operation_name varchar(255), primary key (id));
create table contextual_word_meaning (page_number integer not null, created_at timestamp(6) not null, translation_language_code varchar(10) not null, book_id uuid not null, id uuid not null, word_analysis_id uuid not null, word_instance_id varchar(100) not null, paragraph_text TEXT not null, translation_text TEXT not null, word_text_in_context TEXT not null, request_context_details jsonb, primary key (id));
create table dictionary_word (created_at timestamp(6) not null, language_code varchar(10) not null, id uuid not null, word_text TEXT not null, primary key (id), unique (word_text, language_code));
create table model_configuration (avg_response_time_ms integer, cost_per_1k_input_tokens numeric(10,6), cost_per_1k_output_tokens numeric(10,6), default_temperature float(53), is_enabled boolean not null, max_context_tokens integer, max_output_tokens integer, success_rate float(53), created_at timestamp(6) not null, updated_at timestamp(6), id uuid not null, performance_tier varchar(20), model_id varchar(50) not null unique, provider varchar(50) not null, model_name varchar(100) not null, api_endpoint varchar(500), supported_features TEXT, primary key (id));
create table paragraph_context (created_at timestamp(6) not null, context_hash varchar(64) not null, paragraph_text TEXT not null, primary key (context_hash));
create table prompt_ab_test (confidence_level float(53), min_sample_size integer, statistical_significance float(53), traffic_split_a integer not null, traffic_split_b integer not null, created_at timestamp(6) not null, end_date timestamp(6), start_date timestamp(6), updated_at timestamp(6), id uuid not null, status varchar(20) not null check (status in ('DRAFT','ACTIVE','PAUSED','COMPLETED','CANCELLED','FAILED')), version_a varchar(20) not null, version_b varchar(20) not null, winner varchar(20), primary_metric varchar(50) check (primary_metric in ('SUCCESS_RATE','RESPONSE_TIME','COST_EFFICIENCY','QUALITY_SCORE','TOKEN_EFFICIENCY')), prompt_identifier varchar(100) not null, created_by varchar(255), description TEXT, results_summary TEXT, target_groups TEXT, test_name varchar(255) not null, updated_by varchar(255), primary key (id));
create table prompt_template (is_active boolean not null, is_deprecated boolean not null, max_tokens integer, temperature float(53), created_at timestamp(6) not null, deprecated_at timestamp(6), updated_at timestamp(6), target_language_code varchar(10), id uuid not null, version varchar(20) not null, category varchar(50), default_model varchar(50), identifier varchar(100) not null, created_by varchar(255), deprecated_by varchar(255), description TEXT, input_schema TEXT, name varchar(255) not null, output_schema TEXT, prompt_content TEXT not null, updated_by varchar(255), primary key (id), unique (identifier, version));
create table prompt_usage_log (estimated_cost_usd numeric(10,6) not null, has_quality_issue boolean not null, input_tokens integer not null, max_tokens integer, output_tokens integer not null, quality_score float(53), success boolean not null, temperature float(53), total_tokens integer not null, created_at timestamp(6) not null, execution_time_ms bigint not null, book_id uuid, id uuid not null, prompt_template_id uuid, user_id uuid, api_version varchar(20), environment varchar(20), prompt_version varchar(20), llm_model varchar(50) not null, prompt_identifier varchar(100) not null, word_instance_id varchar(100), error_message TEXT, request_payload TEXT, response_payload TEXT, primary key (id));
create table quality_report (led_to_prompt_update boolean not null, created_at timestamp(6) not null, reviewed_at timestamp(6), id uuid not null, usage_log_id uuid not null, user_id uuid not null, severity varchar(20) not null check (severity in ('LOW','MEDIUM','HIGH','CRITICAL')), status varchar(20) not null check (status in ('PENDING','UNDER_REVIEW','ACKNOWLEDGED','RESOLVED','DISMISSED','ESCALATED')), report_type varchar(50) not null check (report_type in ('INCORRECT_TRANSLATION','BAD_WORD_ANALYSIS','POOR_OCR_STRUCTURING','MISSING_CONTEXT','WRONG_LANGUAGE','GRAMMATICAL_ERROR','SEMANTIC_ERROR','FORMATTING_ISSUE','OTHER')), action_taken TEXT, context_info TEXT, problematic_content TEXT, review_notes TEXT, reviewed_by varchar(255), suggested_correction TEXT, user_description TEXT, primary key (id));
create table user_book_progress (last_read_page_number integer not null, updated_at timestamp(6) with time zone not null, book_id uuid not null, user_id uuid not null, primary key (book_id, user_id));
create table user_quiz_configuration (flashcard_show_context_sentence boolean not null, words_per_session integer not null, created_at timestamp(6) with time zone not null, updated_at timestamp(6) with time zone not null, id uuid not null, user_id uuid not null, flashcard_recto_type varchar(255) not null check (flashcard_recto_type in ('ARABIC_WORD','TRANSLATION')), name varchar(255) not null, primary key (id));
create table user_quiz_configuration_book_ids (book_id uuid, configuration_id uuid not null);
create table user_quiz_configuration_word_type_filters (configuration_id uuid not null, word_type varchar(255));
create table user_settings (id uuid not null, user_id uuid not null unique, reading_theme varchar(50) not null check (reading_theme in ('LIGHT','DARK','SEPIA')), primary key (id));
create table user_word_learning_state (consecutive_correct_reviews integer, ease_factor float4, interval_days integer, is_learning boolean, lapses integer, learning_step integer, srs_level integer not null, created_at timestamp(6) with time zone not null, last_reviewed_at timestamp(6) with time zone, next_review_at timestamp(6) with time zone, updated_at timestamp(6) with time zone not null, id uuid not null, user_id uuid not null, word_analysis_id uuid not null, primary key (id), unique (user_id, word_analysis_id));
create table user_word_list (is_default boolean not null, language_code varchar(5) not null, created_at timestamp(6) with time zone not null, updated_at timestamp(6) with time zone, book_id uuid, id uuid not null, user_id uuid not null, list_name varchar(255) not null, primary key (id));
create table user_word_list_item (page_number integer not null, added_at timestamp(6) with time zone not null, book_id uuid not null, id uuid not null, list_id uuid not null, user_id uuid not null, word_analysis_id uuid, word_instance_id varchar(100) not null, word_text TEXT not null, primary key (id), constraint ux_userwordlistitem_list_book_wordinstance unique (list_id, book_id, word_instance_id));
create table users (created_at timestamp(6) with time zone not null, updated_at timestamp(6) with time zone, id uuid not null, auth0_user_id varchar(255) not null unique, email varchar(255) unique, primary key (id));
create table word_analysis (created_at timestamp(6) not null, dictionary_word_id uuid not null, id uuid not null, source varchar(50), analysis_data jsonb not null, primary key (id));
create table word_context (page_number integer not null, created_at timestamp(6) not null, book_id uuid not null, id uuid not null, word_analysis_id uuid not null, word_translation_id uuid not null, context_hash varchar(64) not null, word_instance_id varchar(100) not null, word_text_in_context TEXT not null, primary key (id), constraint ux_word_context_instance unique (book_id, page_number, word_instance_id));
create table word_count_statistics (arabic_words integer not null, average_word_length numeric(5,2) not null, digits_count integer not null, latin_words integer not null, page_number integer not null, punctuation_count integer not null, total_words integer not null, unique_words integer not null, created_at timestamp(6) not null, updated_at timestamp(6), book_id uuid not null, id uuid not null, primary key (id), constraint unique_book_page_word_count unique (book_id, page_number));
create table word_translation (confidence_score float(53), language_code varchar(5) not null, created_at timestamp(6) not null, id uuid not null, word_analysis_id uuid not null, source varchar(50), translation_text TEXT not null, primary key (id), constraint ux_word_translation_unique unique (word_analysis_id, language_code, translation_text));
create index idx_contextual_meaning_lookup on contextual_word_meaning (book_id, page_number, word_instance_id, translation_language_code);
create index idx_paragraph_context_hash on paragraph_context (context_hash);
create index idx_ab_test_prompt_identifier on prompt_ab_test (prompt_identifier);
create index idx_ab_test_status on prompt_ab_test (status);
create index idx_ab_test_created_at on prompt_ab_test (created_at);
create index idx_prompt_identifier on prompt_usage_log (prompt_identifier);
create index idx_llm_model on prompt_usage_log (llm_model);
create index idx_created_at on prompt_usage_log (created_at);
create index idx_user_id on prompt_usage_log (user_id);
create index idx_book_id on prompt_usage_log (book_id);
create index idx_usage_log_id on quality_report (usage_log_id);
create index idx_report_type on quality_report (report_type);
create index idx_severity on quality_report (severity);
create index idx_qr_created_at on quality_report (created_at);
create index idx_qr_user_id on quality_report (user_id);
create index idx_word_analysis_dict_id on word_analysis (dictionary_word_id);
create index idx_word_context_lookup on word_context (book_id, page_number, word_instance_id);
create index idx_word_context_translation on word_context (word_translation_id);
create index idx_word_context_analysis on word_context (word_analysis_id);
create index idx_word_translation_lookup on word_translation (word_analysis_id, language_code);
create index idx_word_translation_confidence on word_translation (confidence_score desc);
alter table if exists book add constraint FK9cv1tt952k857xoia51k1vj12 foreign key (user_id) references users;
alter table if exists contextual_word_meaning add constraint FKds79of3vls9aop5nh866m2mu foreign key (word_analysis_id) references word_analysis;
alter table if exists user_book_progress add constraint FK9rc27c1hm18cfs9ah1xlhxvdl foreign key (book_id) references book;
alter table if exists user_book_progress add constraint FKgltyxj2f11q70nrgqr1f6gb3m foreign key (user_id) references users;
alter table if exists user_quiz_configuration add constraint FKpsyrb374st7q0y4f6ypibx12j foreign key (user_id) references users;
alter table if exists user_quiz_configuration_book_ids add constraint FK20t8dmc8eo7i48kv5vj1n7h2q foreign key (configuration_id) references user_quiz_configuration;
alter table if exists user_quiz_configuration_word_type_filters add constraint FKml68k8s5hor2jal16600d7q6y foreign key (configuration_id) references user_quiz_configuration;
alter table if exists user_settings add constraint FK8v82nj88rmai0nyck19f873dw foreign key (user_id) references users;
alter table if exists user_word_learning_state add constraint FKm0duytjiee15ot0c35h5dmswi foreign key (user_id) references users;
alter table if exists user_word_learning_state add constraint FKgubh9ktv30xqy52rsll9okk4f foreign key (word_analysis_id) references word_analysis;
alter table if exists user_word_list add constraint FKpsf6mq56v840ni0eoupaxkvjq foreign key (book_id) references book;
alter table if exists user_word_list add constraint FKs5wxk2ov6giinj8pkecy6x6sk foreign key (user_id) references users;
alter table if exists user_word_list_item add constraint FKpv03rag4cm783hun2wwlr6r4n foreign key (book_id) references book;
alter table if exists user_word_list_item add constraint FK1vhv7th89nvbglmje1suux6fe foreign key (user_id) references users;
alter table if exists user_word_list_item add constraint FK545lee4c4oorkbmo7iujo1wct foreign key (word_analysis_id) references word_analysis;
alter table if exists user_word_list_item add constraint FKtifq81i3ei79y8pfn1i0g688o foreign key (list_id) references user_word_list;
alter table if exists word_context add constraint FKoyh9a8p2q8qw3llnn9e5y2l1s foreign key (context_hash) references paragraph_context;
alter table if exists word_context add constraint FKjm51q3ghwx0diuwn1xojjf60s foreign key (word_analysis_id) references word_analysis;
alter table if exists word_context add constraint FKcjri3xe6vq4t5o7di0nevihn0 foreign key (word_translation_id) references word_translation;
